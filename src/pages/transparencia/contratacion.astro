---
import Layout from "../../layouts/Layout.astro";
import { fetchGraphQL } from "../../lib/wp.ts";
import { InformacionContratos } from "../../lib/queries/Contratos"; 

const title = "Contratación";
const description = "Encuentre información sobre los procesos de contratación municipal";
const contratosData = await fetchGraphQL(InformacionContratos);

const contratosList = contratosData?.contratos?.nodes?.map((node) => {
    const contrato = node.datosDeContratos;
    return {
        title: contrato.titulo || 'Contrato sin título',
        number: contrato.numeroDeContrato || 'N/A',
        description: contrato.descripcion || 'Detalles no disponibles.',
        date: contrato.fechaDeContrato || 'Fecha N/A',
        url: contrato.documentoDeContrato?.node?.mediaItemUrl || "#",
    };
}) || [];
---

<Layout title={title} description={description}>
    <div class="h-16"></div>
    <main class="container mx-auto px-4 py-8 font-sans">
        <h1 class="text-4xl font-bold text-center text-concejo-verde-principal mb-8">Contratación</h1>
        <p class="text-lg text-gray-700 text-center mb-10 max-w-4xl mx-auto">
            Toda la información referente a la actividad contractual del Concejo Municipal del Medio Atrato y el acceso a los sistemas públicos de compra.
        </p>
        <div class="max-w-4xl mx-auto mb-16 bg-white rounded-xl shadow-2xl p-8 border-t-8 border-concejo-azul-principal">
            <h2 class="text-3xl font-bold text-concejo-negro mb-4 flex items-center space-x-3">
                <svg class="w-8 h-8 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0a2 2 0 01-2-2v-8a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2H7z"></path></svg>
                <span>Sistema de Contratación Pública (SECOP I)</span>
            </h2>
            <p class="text-gray-700 mb-6">
                Acceda directamente a la plataforma donde se publica la totalidad de la actividad contractual del Concejo, incluyendo licitaciones, pliegos y adjudicaciones.
            </p>
            
            <a href="https://www.contratos.gov.co/consultas/inicioConsulta.do" target="_blank" class="inline-block bg-concejo-verde-principal text-white px-6 py-3 rounded-full font-bold shadow-md hover:bg-concejo-negro transition-colors duration-300">
                Ir al SECOP I
            </a>
        </div>

        <h2 class="text-3xl font-bold text-concejo-negro mb-6 border-b pb-2 max-w-6xl mx-auto">Documentos de Contratación</h2>
        <div class="max-w-6xl mx-auto">
            {contratosList.length > 0 ? (
                <div class="bg-white rounded-xl shadow-xl divide-y divide-gray-100 border border-gray-200">
                    <ul class="space-y-0">
                        {contratosList.map((contrato) => (
                            <li class="p-4 hover:bg-gray-50 transition-colors duration-200">
                                <a 
                                    href={contrato.url} 
                                    target="_blank" 
                                    rel="noopener noreferrer" 
                                    class="flex flex-col sm:flex-row justify-between items-start sm:items-center text-concejo-negro group"
                                >
                                    <div class="flex items-start">
                                        <i class="fas fa-file-contract text-concejo-azul-principal text-xl mr-4 mt-1 flex-shrink-0" aria-hidden="true"></i>
                                        <div>
                                            <p class="text-xs font-semibold text-gray-500">Contrato No. {contrato.number} | Fecha: {contrato.date}</p>
                                            <h4 class="text-lg font-medium group-hover:underline">{contrato.title}</h4>
                                            <p class="text-sm text-gray-700 mt-1 line-clamp-2">{contrato.description}</p>
                                        </div>
                                    </div>
                                    <div class="text-right mt-2 sm:mt-0 flex-shrink-0">
                                        <span class="text-sm font-semibold text-concejo-azul-principal">Descargar PDF →</span>
                                    </div>
                                </a>
                            </li>
                        ))}
                    </ul>
                </div>
            ) : (
                <div class="p-10 text-center text-gray-500 bg-gray-50 rounded-lg shadow-md border border-gray-200 max-w-6xl mx-auto">
                    <i class="fas fa-file-invoice-dollar text-4xl mb-3"></i>
                    <h3 class="text-xl font-semibold">No hay Contratos publicados en este momento.</h3>
                    <p class="mt-2">Puede consultar la actividad contractual completa a través del enlace al SECOP I.</p>
                </div>
            )}
        </div>
    </main>
</Layout>