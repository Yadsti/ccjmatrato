---
import Layout from "../../../layouts/Layout.astro";
import { fetchGraphQL } from "../../../lib/wp.ts";
import { InformacionNoticias } from "../../../lib/queries/noticias.ts";

interface NoticiaDetail {
    fecha: string;
    titulo: string;
    resumen: string;
    contenido: string;
    imageUrl: string;
    imageAlt: string;
    documentUrl: string | null;
    slug: string;
}

interface Props {
    post: NoticiaDetail;
}

const { post } = Astro.props;

export async function getStaticPaths() {
    const WP_BASE_URL = import.meta.env.WORDPRESS_API_URL.replace("/graphql", "");
    const noticiasData = await fetchGraphQL(InformacionNoticias);
    const paths = noticiasData?.noticias?.edges?.map((edge) => {
        const noticia = edge.node.datosDeLasNoticias;
        const imageUri = noticia.imagenDeLaNoticia?.node?.uri;
        const imageUrl = imageUri ? `${WP_BASE_URL}${imageUri}` : "/noticias/default.jpg";
        const postSlug = noticia.tituloDeNoticia?.toLowerCase().replace(/[^\w\s-]/g, '').replace(/[\s_]+/g, '-');

        const postData: NoticiaDetail = {
            fecha: noticia.fechaDeLaNoticia,
            titulo: noticia.tituloDeNoticia,
            resumen: noticia.resumen,
            contenido: noticia.descripcionDeLaNoticia,
            imageUrl: imageUrl,
            imageAlt: noticia.imagenDeLaNoticia?.node?.altText || `Imagen de ${noticia.tituloDeNoticia}`,
            documentUrl: noticia.documentoDeNoticia?.node?.mediaItemUrl || null,
            slug: postSlug, 
        };

        return {
            params: { slug: postData.slug }, 
            props: { post: postData },
        };
    }) || [];

    return paths;
}

const title = post.titulo;
const description = post.resumen;
const cleanContent = post.contenido; 
---

<Layout title={title} description={description}>
    <main class="container mx-auto px-4 py-12 font-sans">
        <section class="max-w-4xl mx-auto mb-10 text-center">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-concejo-negro mb-3 leading-tight">
                {post.titulo}
            </h1>
            <p class="text-sm font-semibold text-concejo-azul-principal uppercase">
                Publicado el {post.fecha}
            </p>
            <hr class="w-16 h-1 mx-auto mt-4 bg-concejo-verde-principal border-0 rounded-full">
        </section>

        <section class="max-w-5xl mx-auto">
            
            {/* Imagen Principal */}
            <figure class="mb-8 rounded-xl overflow-hidden shadow-2xl">
                <img 
                    src={post.imageUrl} 
                    alt={post.imageAlt} 
                    class="w-full h-auto max-h-[500px] object-cover"
                >
            </figure>

            {post.documentUrl && (
                <div class="mb-8 p-4 bg-yellow-50 border-l-4 border-concejo-amarillo rounded-lg flex items-center justify-between shadow-sm">
                    <p class="text-gray-800 font-medium">
                        <i class="fas fa-paperclip mr-2 text-concejo-amarillo" aria-hidden="true"></i>
                        Descargue el documento relacionado con esta noticia.
                    </p>
                    <a 
                        href={post.documentUrl} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        class="bg-concejo-azul-principal text-white font-semibold py-2 px-4 rounded-lg hover:bg-concejo-verde-principal transition-colors duration-300 flex items-center text-sm"
                    >
                        Descargar Documento
                        <i class="fas fa-download ml-2" aria-hidden="true"></i>
                    </a>
                </div>
            )}

            <p class="text-xl text-gray-800 italic mb-8 border-l-4 border-concejo-azul-principal pl-4 leading-relaxed">
                {post.resumen}
            </p>

            <div class="prose prose-lg max-w-none text-gray-700">
                <div set:html={cleanContent}></div>
            </div>

            <hr class="my-12">

            <div class="text-center">
                <a href="/transparencia/noticias" class="inline-flex items-center text-concejo-verde-principal font-semibold hover:underline">
                    <i class="fas fa-arrow-left mr-2" aria-hidden="true"></i>
                    Volver al Archivo de Noticias
                </a>
            </div>

        </section>
    </main>
</Layout>