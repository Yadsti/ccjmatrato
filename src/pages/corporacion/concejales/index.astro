---
import Layout from "../../../layouts/Layout.astro";
import DirectorioConcejales from "../../../components/DirectorioConcejales.astro";
import { fetchGraphQL } from "../../../lib/wp.ts";
import { InformacionConcejales } from "../../../lib/queries/concejales.ts"; 
import { InformacionSecretaria } from "../../../lib/queries/secretaria.ts"; 

const WP_BASE_URL = import.meta.env.WORDPRESS_API_URL.replace("/graphql", "");
const concejalesData = await fetchGraphQL(InformacionConcejales);

const concejalesList = concejalesData?.concejales?.edges?.map((edge) => {
    const concejalData = edge.node.datosDeConcejales;
    // ... (Tu lógica de mapeo de concejales aquí) ...
    // Asegúrate de que los concejales de la Mesa Directiva NO tengan el rol de 'Secretaria' si el CPT 'Concejales' ya no lo contiene.
    const positionString = concejalData.cargoDelConcejal || 'Concejal';

    const photoUri = concejalData.fotoDelConcejal?.node?.uri;
    const photoUrl = photoUri ? `${WP_BASE_URL}${photoUri}` : "/concejales/default.jpg";
    
    return {
        name: concejalData.nombreDeConcejal,
        position: positionString,
        photoUrl: photoUrl,
        comunidad: concejalData.comunidad || 'N/A',
        partido: concejalData.partidoPolitico,
        email: concejalData.correoElectronico,
        slug: 'slug-aqui',
    };
}) || []; 

const secretariaRawData = await fetchGraphQL(InformacionSecretaria);
const secretariaNode = secretariaRawData?.secretarias?.nodes?.[0]?.datosDeSecretaria;
let secretariaData = null;
if (secretariaNode) {
    const photoUri = secretariaNode.foto?.node?.uri;
    const photoUrl = photoUri ? `${WP_BASE_URL}${photoUri}` : "/default-secretaria.jpg";
    
    secretariaData = {
        name: secretariaNode.nombre,
        position: 'Secretaria General', 
        photoUrl: photoUrl,
        comunidad: 'Sede Administrativa',
        resumen: 'Lidera la gestión documental y administrativa del Concejo Municipal.',
    };
}

const title = "Directorio de Concejales";
const description = "Conozca a los miembros del Concejo y la Mesa Directiva.";
---

<Layout title={title} description={description}>
    <main class="container mx-auto">
        <DirectorioConcejales 
            concejalesList={concejalesList} 
            secretariaData={secretariaData} 
        />
    </main>
</Layout>